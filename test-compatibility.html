<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Furlg 浏览器兼容性测试</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .success { color: #28a745; }
        .warning { color: #ffc107; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .result {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>🔍 Furlg 浏览器兼容性测试</h1>
    
    <div class="test-section">
        <h2>📊 浏览器信息检测</h2>
        <button onclick="detectBrowser()">检测浏览器</button>
        <div id="browser-info" class="result"></div>
    </div>

    <div class="test-section">
        <h2>🔖 书签API测试</h2>
        <button onclick="testBookmarkAPI()">测试书签API</button>
        <button onclick="testPermissions()">检查权限</button>
        <button onclick="requestPermissions()">请求权限</button>
        <div id="bookmark-test" class="result"></div>
    </div>

    <div class="test-section">
        <h2>📚 获取书签数据</h2>
        <button onclick="getBookmarks()">获取书签</button>
        <div id="bookmark-data" class="result"></div>
    </div>

    <div class="test-section">
        <h2>🧪 完整兼容性报告</h2>
        <button onclick="generateReport()">生成报告</button>
        <div id="compatibility-report" class="result"></div>
    </div>

    <script>
        // 浏览器检测
        function detectBrowser() {
            const userAgent = navigator.userAgent;
            let browserInfo = {
                userAgent: userAgent,
                name: 'Unknown',
                version: '',
                isChrome: false,
                isEdge: false,
                isFirefox: false,
                isSafari: false
            };

            // 检测Edge
            if (userAgent.includes('Edg/')) {
                browserInfo.name = 'Microsoft Edge';
                browserInfo.isEdge = true;
                const match = userAgent.match(/Edg\/([0-9.]+)/);
                browserInfo.version = match ? match[1] : '';
            }
            // 检测Chrome
            else if (userAgent.includes('Chrome/') && !userAgent.includes('Edg/')) {
                browserInfo.name = 'Google Chrome';
                browserInfo.isChrome = true;
                const match = userAgent.match(/Chrome\/([0-9.]+)/);
                browserInfo.version = match ? match[1] : '';
            }
            // 检测Firefox
            else if (userAgent.includes('Firefox/')) {
                browserInfo.name = 'Mozilla Firefox';
                browserInfo.isFirefox = true;
                const match = userAgent.match(/Firefox\/([0-9.]+)/);
                browserInfo.version = match ? match[1] : '';
            }
            // 检测Safari
            else if (userAgent.includes('Safari/') && !userAgent.includes('Chrome/')) {
                browserInfo.name = 'Safari';
                browserInfo.isSafari = true;
                const match = userAgent.match(/Version\/([0-9.]+)/);
                browserInfo.version = match ? match[1] : '';
            }

            document.getElementById('browser-info').innerHTML = 
                `浏览器名称: ${browserInfo.name}\n` +
                `版本: ${browserInfo.version}\n` +
                `User Agent: ${browserInfo.userAgent}\n` +
                `是否Chrome: ${browserInfo.isChrome}\n` +
                `是否Edge: ${browserInfo.isEdge}\n` +
                `是否Firefox: ${browserInfo.isFirefox}\n` +
                `是否Safari: ${browserInfo.isSafari}`;
        }

        // 测试书签API
        function testBookmarkAPI() {
            let result = '书签API测试结果:\n\n';
            
            // 检查Chrome API
            if (typeof chrome !== 'undefined') {
                result += '✅ Chrome对象存在\n';
                if (chrome.bookmarks) {
                    result += '✅ chrome.bookmarks API可用\n';
                } else {
                    result += '❌ chrome.bookmarks API不可用\n';
                }
            } else {
                result += '❌ Chrome对象不存在\n';
            }

            // 检查WebExtension API
            if (typeof browser !== 'undefined') {
                result += '✅ Browser对象存在\n';
                if (browser.bookmarks) {
                    result += '✅ browser.bookmarks API可用\n';
                } else {
                    result += '❌ browser.bookmarks API不可用\n';
                }
            } else {
                result += '❌ Browser对象不存在\n';
            }

            // 检查全局chrome
            if (typeof window !== 'undefined' && window.chrome && window.chrome.bookmarks) {
                result += '✅ 全局chrome.bookmarks可用\n';
            } else {
                result += '❌ 全局chrome.bookmarks不可用\n';
            }

            document.getElementById('bookmark-test').innerHTML = result;
        }

        // 检查权限
        async function testPermissions() {
            let result = '权限检查结果:\n\n';
            
            try {
                if (chrome && chrome.permissions) {
                    result += '✅ chrome.permissions API可用\n';
                    
                    const hasPermission = await new Promise((resolve) => {
                        chrome.permissions.contains({
                            permissions: ['bookmarks']
                        }, resolve);
                    });
                    
                    result += `书签权限状态: ${hasPermission ? '✅ 已授权' : '❌ 未授权'}\n`;
                } else {
                    result += '❌ chrome.permissions API不可用\n';
                }
            } catch (error) {
                result += `❌ 权限检查失败: ${error.message}\n`;
            }

            document.getElementById('bookmark-test').innerHTML = result;
        }

        // 请求权限
        async function requestPermissions() {
            let result = '权限请求结果:\n\n';
            
            try {
                if (chrome && chrome.permissions) {
                    const granted = await new Promise((resolve) => {
                        chrome.permissions.request({
                            permissions: ['bookmarks']
                        }, resolve);
                    });
                    
                    result += `权限请求结果: ${granted ? '✅ 已授权' : '❌ 被拒绝'}\n`;
                } else {
                    result += '❌ chrome.permissions API不可用，无法请求权限\n';
                }
            } catch (error) {
                result += `❌ 权限请求失败: ${error.message}\n`;
            }

            document.getElementById('bookmark-test').innerHTML = result;
        }

        // 获取书签
        async function getBookmarks() {
            let result = '书签获取结果:\n\n';
            
            try {
                let bookmarkTree = null;
                
                if (chrome && chrome.bookmarks) {
                    result += '使用chrome.bookmarks API\n';
                    bookmarkTree = await new Promise((resolve, reject) => {
                        chrome.bookmarks.getTree((tree) => {
                            if (chrome.runtime.lastError) {
                                reject(new Error(chrome.runtime.lastError.message));
                            } else {
                                resolve(tree);
                            }
                        });
                    });
                } else if (browser && browser.bookmarks) {
                    result += '使用browser.bookmarks API\n';
                    bookmarkTree = await browser.bookmarks.getTree();
                } else {
                    throw new Error('没有可用的书签API');
                }

                // 提取书签
                const bookmarks = [];
                function extractBookmarks(nodes) {
                    nodes.forEach(node => {
                        if (node.url && node.title) {
                            if (node.url.startsWith('http://') || node.url.startsWith('https://')) {
                                bookmarks.push({
                                    title: node.title,
                                    url: node.url
                                });
                            }
                        }
                        if (node.children) {
                            extractBookmarks(node.children);
                        }
                    });
                }

                extractBookmarks(bookmarkTree);
                
                result += `✅ 成功获取 ${bookmarks.length} 个书签\n\n`;
                result += '前10个书签:\n';
                bookmarks.slice(0, 10).forEach((bookmark, index) => {
                    result += `${index + 1}. ${bookmark.title}\n   ${bookmark.url}\n\n`;
                });

            } catch (error) {
                result += `❌ 获取书签失败: ${error.message}\n`;
            }

            document.getElementById('bookmark-data').innerHTML = result;
        }

        // 生成完整报告
        function generateReport() {
            detectBrowser();
            testBookmarkAPI();
            
            setTimeout(() => {
                const browserInfo = document.getElementById('browser-info').innerHTML;
                const bookmarkTest = document.getElementById('bookmark-test').innerHTML;
                
                const report = 
                    '=== Furlg 浏览器兼容性报告 ===\n\n' +
                    '浏览器信息:\n' + browserInfo + '\n\n' +
                    '书签API测试:\n' + bookmarkTest + '\n\n' +
                    '建议:\n';
                
                let recommendations = '';
                if (browserInfo.includes('Microsoft Edge')) {
                    if (bookmarkTest.includes('chrome.bookmarks API可用')) {
                        recommendations += '✅ Edge浏览器完全支持，可以使用直接导入功能\n';
                    } else {
                        recommendations += '⚠️ Edge浏览器API受限，建议使用文件导入方式\n';
                        recommendations += '   导出方式: 设置 → 收藏夹 → 导出收藏夹\n';
                    }
                } else if (browserInfo.includes('Google Chrome')) {
                    recommendations += '✅ Chrome浏览器完全支持\n';
                } else if (browserInfo.includes('Mozilla Firefox')) {
                    recommendations += '⚠️ Firefox可能需要使用WebExtension API\n';
                } else {
                    recommendations += '❌ 未知浏览器，建议使用文件导入方式\n';
                }

                document.getElementById('compatibility-report').innerHTML = report + recommendations;
            }, 100);
        }

        // 页面加载时自动检测
        window.onload = function() {
            detectBrowser();
        };
    </script>
</body>
</html>
